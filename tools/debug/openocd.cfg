# OpenOCD configuration for ESP32-S3 T-Display with built-in USB-JTAG

# Adapter configuration
adapter driver esp_usb_jtag
adapter speed 20000

# Target configuration
set _CHIPNAME esp32s3
set _CPUTAPID 0x120034e5

# Configure target
jtag newtap $_CHIPNAME cpu -irlen 5 -expected-id $_CPUTAPID

set _TARGETNAME $_CHIPNAME.cpu
target create $_TARGETNAME esp32s3 -chain-position $_TARGETNAME

# Configure work area
$_TARGETNAME configure -work-area-phys 0x40370000 -work-area-size 0x10000 -work-area-backup 1

# Flash configuration
set _FLASHSIZE 0x1000000
set _FLASH_FREQ 40m

# Configure flash
flash bank $_CHIPNAME.flash esp32s3 0x0 $_FLASHSIZE 0 0 $_TARGETNAME
flash bank $_CHIPNAME.irom esp32s3 0x40000000 $_FLASHSIZE 0 0 $_TARGETNAME
flash bank $_CHIPNAME.drom esp32s3 0x3C000000 $_FLASHSIZE 0 0 $_TARGETNAME

# Event handlers
$_TARGETNAME configure -event reset-assert {
    esp32s3 memprot_is_locked
}

$_TARGETNAME configure -event gdb-attach {
    halt
}

$_TARGETNAME configure -event examine-end {
    # Enable flash support
    flash probe 0
    flash probe 1 
    flash probe 2
}

# Custom commands for display debugging
proc dump_display_state {} {
    echo "=== Display State Debug ==="
    # Read GPIO registers for display pins
    echo "GPIO Matrix:"
    mdw 0x60004000 32
    
    # Check LCD_CAM peripheral
    echo "LCD_CAM Registers:"
    mdw 0x60041000 32
}

# Initialize
init