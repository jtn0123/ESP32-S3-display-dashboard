<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ESP32-S3 File Manager</title>
    <link rel="manifest" href="/static/manifest.json">
    <style>
        /* Dark Mode Design System */
        :root {
            --bg-main: #0a0a0a;
            --bg-card: #1a1a1a;
            --bg-hover: #2a2a2a;
            --bg-input: #262626;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text: #f9fafb;
            --text-dim: #9ca3af;
            --text-muted: #6b7280;
            --border: #374151;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-main);
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--bg-hover);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-input);
        }

        /* File Browser */
        .file-browser {
            display: flex;
            height: calc(100vh - 140px);
            gap: 1rem;
            padding: 1rem;
        }

        /* File Tree */
        .file-tree {
            width: 250px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .tree-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
        }

        .tree-content {
            padding: 0.5rem;
        }

        .tree-item {
            padding: 0.5rem;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .tree-item:hover {
            background: var(--bg-hover);
        }

        .tree-item.selected {
            background: var(--accent);
            color: white;
        }

        .tree-icon {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        /* File Editor */
        .file-editor {
            flex: 1;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .editor-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .editor-title {
            font-weight: 600;
        }

        .editor-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .editor-actions {
            display: flex;
            gap: 0.5rem;
        }

        .editor-content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #editor {
            width: 100%;
            height: 100%;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
            font-size: 14px;
        }

        .editor-textarea {
            width: 100%;
            height: 100%;
            background: var(--bg-main);
            color: var(--text);
            border: none;
            padding: 1rem;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
            font-size: 14px;
            resize: none;
            outline: none;
        }

        /* Upload Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow);
        }

        .modal-header {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 3rem;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
        }

        .upload-area:hover,
        .upload-area.drag-over {
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.1);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .upload-text {
            color: var(--text-dim);
            margin-bottom: 0.5rem;
        }

        .upload-input {
            display: none;
        }

        /* Status Bar */
        .status-bar {
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .footer-nav {
            display: flex;
            gap: 0.5rem;
        }

        .footer-nav a {
            color: var(--text-muted);
            text-decoration: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .footer-nav a:hover {
            background: var(--bg-hover);
            color: var(--text);
        }

        .footer-nav a.active {
            color: var(--accent);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .file-browser {
                flex-direction: column;
            }

            .file-tree {
                width: 100%;
                height: 200px;
                margin-bottom: 1rem;
            }

            .editor-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .footer-nav {
                display: none;
            }
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--accent);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 0.5rem;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>File Manager</h1>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="refreshFiles()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 4v6h-6M1 20v-6h6"/>
                    <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                </svg>
                Refresh
            </button>
            <button class="btn" onclick="showUploadModal()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                Upload
            </button>
        </div>
    </header>

    <div class="file-browser">
        <div class="file-tree">
            <div class="tree-header">Files</div>
            <div class="tree-content" id="fileTree">
                <div class="loading">
                    <span class="spinner"></span>
                    Loading files...
                </div>
            </div>
        </div>

        <div class="file-editor">
            <div class="editor-header">
                <div class="editor-info">
                    <div class="editor-title" id="editorTitle">Select a file to edit</div>
                    <div class="editor-meta" id="editorMeta"></div>
                </div>
                <div class="editor-actions" id="editorActions" style="display: none;">
                    <button class="btn btn-secondary" onclick="reloadFile()">Reload</button>
                    <button class="btn" onclick="saveFile()">Save</button>
                </div>
            </div>
            <div class="editor-content">
                <div id="editor"></div>
            </div>
        </div>
    </div>

    <div class="status-bar">
        <div class="status-left">
            <span id="statusText">Ready</span>
        </div>
        <div class="footer-nav">
            <a href="/">üè† Home</a>
            <a href="/dashboard">üìä Dashboard</a>
            <a href="/logs">üìã Logs</a>
            <a href="/files" class="active">üìÅ Files</a>
            <a href="/ota">‚¨ÜÔ∏è Update</a>
        </div>
        <div class="status-right">
            <span id="fileCount">0 files</span>
        </div>
    </div>

    <!-- Upload Modal -->
    <div class="modal" id="uploadModal">
        <div class="modal-content">
            <div class="modal-header">Upload File</div>
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">Drop files here or click to browse</div>
                <div class="upload-hint">Supported: .json, .toml, .log, .bin, .txt, .md</div>
                <input type="file" class="upload-input" id="uploadInput" accept=".json,.toml,.log,.bin,.txt,.md" multiple>
            </div>
            <div style="margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="hideUploadModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Monaco Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    <script>
        // Global state
        let editor = null;
        let currentFile = null;
        let isDirty = false;
        let files = [];

        // Initialize Monaco Editor
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' }});
        require(['vs/editor/editor.main'], function() {
            editor = monaco.editor.create(document.getElementById('editor'), {
                value: '// Select a file to edit',
                language: 'json',
                theme: 'vs-dark',
                automaticLayout: true,
                minimap: { enabled: false },
                fontSize: 14,
                wordWrap: 'on',
                scrollBeyondLastLine: false,
                renderWhitespace: 'selection',
                tabSize: 2,
                insertSpaces: true
            });

            editor.onDidChangeModelContent(() => {
                if (currentFile) {
                    isDirty = true;
                    updateStatus('Modified');
                }
            });
        });

        // Load file tree
        async function loadFiles(path = '/') {
            try {
                const response = await fetch(`/api/files?path=${encodeURIComponent(path)}`);
                const data = await response.json();
                files = data.files || [];
                renderFileTree(files);
                document.getElementById('fileCount').textContent = `${files.length} files`;
            } catch (error) {
                console.error('Failed to load files:', error);
                showError('Failed to load files');
            }
        }

        // Render file tree
        function renderFileTree(fileList) {
            const treeContent = document.getElementById('fileTree');
            treeContent.innerHTML = '';

            if (fileList.length === 0) {
                treeContent.innerHTML = '<div class="empty-state">No files found</div>';
                return;
            }

            fileList.forEach(file => {
                const item = document.createElement('div');
                item.className = 'tree-item';
                item.onclick = () => selectFile(file);

                const icon = document.createElement('span');
                icon.className = 'tree-icon';
                icon.textContent = file.type === 'directory' ? 'üìÅ' : getFileIcon(file.name);

                const name = document.createElement('span');
                name.textContent = file.name;

                item.appendChild(icon);
                item.appendChild(name);
                treeContent.appendChild(item);
            });
        }

        // Get file icon based on extension
        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'json': 'üìÑ',
                'toml': 'üìù',
                'log': 'üìã',
                'bin': '‚öôÔ∏è',
                'txt': 'üìÉ',
                'md': 'üìë'
            };
            return icons[ext] || 'üìÑ';
        }

        // Select file
        async function selectFile(file) {
            if (file.type === 'directory') {
                // TODO: Navigate into directory
                return;
            }

            if (isDirty && !confirm('You have unsaved changes. Continue?')) {
                return;
            }

            // Update UI
            document.querySelectorAll('.tree-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            // Load file content
            try {
                updateStatus('Loading...');
                const response = await fetch(`/api/files/content?file=${encodeURIComponent(file.name)}`);
                const data = await response.json();

                currentFile = data;
                isDirty = false;

                // Update editor
                const language = getLanguageFromFilename(file.name);
                monaco.editor.setModelLanguage(editor.getModel(), language);
                editor.setValue(data.content || '');

                // Update header
                document.getElementById('editorTitle').textContent = file.name;
                document.getElementById('editorMeta').textContent = `${formatBytes(data.size)} ‚Ä¢ ${data.readonly ? 'Read-only' : 'Editable'}`;
                document.getElementById('editorActions').style.display = data.readonly ? 'none' : 'flex';

                updateStatus('Ready');
            } catch (error) {
                console.error('Failed to load file:', error);
                showError('Failed to load file');
            }
        }

        // Get Monaco language from filename
        function getLanguageFromFilename(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const languages = {
                'json': 'json',
                'toml': 'ini',
                'log': 'plaintext',
                'txt': 'plaintext',
                'md': 'markdown',
                'js': 'javascript',
                'ts': 'typescript',
                'rs': 'rust',
                'py': 'python'
            };
            return languages[ext] || 'plaintext';
        }

        // Save file
        async function saveFile() {
            if (!currentFile || !isDirty) return;

            try {
                updateStatus('Saving...');
                const response = await fetch(`/api/files/content?file=${encodeURIComponent(currentFile.filename)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: editor.getValue() })
                });

                if (!response.ok) {
                    throw new Error(`Failed to save: ${response.statusText}`);
                }

                isDirty = false;
                updateStatus('Saved');
                setTimeout(() => updateStatus('Ready'), 2000);
            } catch (error) {
                console.error('Failed to save file:', error);
                showError('Failed to save file');
            }
        }

        // Reload file
        function reloadFile() {
            if (currentFile && isDirty && !confirm('Discard changes and reload?')) {
                return;
            }
            if (currentFile) {
                selectFile({ name: currentFile.filename, type: 'file' });
            }
        }

        // Refresh files
        function refreshFiles() {
            loadFiles();
        }

        // Upload functionality
        const uploadArea = document.getElementById('uploadArea');
        const uploadInput = document.getElementById('uploadInput');

        uploadArea.addEventListener('click', () => uploadInput.click());
        uploadInput.addEventListener('change', handleFileSelect);

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            handleFileSelect({ target: { files: e.dataTransfer.files } });
        });

        async function handleFileSelect(event) {
            const fileList = event.target.files;
            if (fileList.length === 0) return;

            for (const file of fileList) {
                await uploadFile(file);
            }

            hideUploadModal();
            refreshFiles();
        }

        async function uploadFile(file) {
            try {
                updateStatus(`Uploading ${file.name}...`);
                
                const response = await fetch('/api/files/upload', {
                    method: 'POST',
                    headers: {
                        'X-Filename': file.name,
                        'Content-Length': file.size.toString()
                    },
                    body: file
                });

                if (!response.ok) {
                    throw new Error(`Upload failed: ${response.statusText}`);
                }

                updateStatus(`Uploaded ${file.name}`);
            } catch (error) {
                console.error('Failed to upload file:', error);
                showError(`Failed to upload ${file.name}`);
            }
        }

        // Modal functions
        function showUploadModal() {
            document.getElementById('uploadModal').classList.add('show');
        }

        function hideUploadModal() {
            document.getElementById('uploadModal').classList.remove('show');
            uploadInput.value = '';
        }

        // Utility functions
        function formatBytes(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function updateStatus(text) {
            document.getElementById('statusText').textContent = text;
        }

        function showError(message) {
            updateStatus(`Error: ${message}`);
            setTimeout(() => updateStatus('Ready'), 5000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 's') {
                    e.preventDefault();
                    saveFile();
                } else if (e.key === 'r') {
                    e.preventDefault();
                    reloadFile();
                }
            }
        });

        // Prevent accidental navigation
        window.addEventListener('beforeunload', (e) => {
            if (isDirty) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // Initialize
        loadFiles();
    </script>
</body>
</html>